<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rute Tracker Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --primary: #667eea; --dark: #2d3748; --light: #f7fafc; }
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: var(--light); margin: 0; padding-bottom: 50px; }
    header { background: var(--primary); color: white; padding: 20px; text-align: center; }
    .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
    .nav { display: flex; justify-content: space-around; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .nav-btn { border: none; background: none; font-weight: bold; color: #a0aec0; cursor: pointer; padding: 10px; }
    .nav-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
    label { display: block; margin: 15px 0 5px; font-size: 0.85rem; font-weight: bold; }
    input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-save { background: var(--primary); color: white; }
    .btn-pdf { background: #48bb78; color: white; margin-top: 10px; }
    .btn-sync { background: #edf2f7; color: var(--dark); }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .stat-card { background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
    .history-item { border-bottom: 1px solid #edf2f7; padding: 15px 0; font-size: 0.9rem; }
  </style>
</head>
<body>

<header>
  <h1>üöö Rute Tracker Pro</h1>
</header>

<div class="nav">
  <button class="nav-btn active" onclick="showTab('daily', this)">üìù Daglig</button>
  <button class="nav-btn" onclick="showTab('dash', this)">üìä Dashboard</button>
  <button class="nav-btn" onclick="showTab('history', this)">üìÖ Historik</button>
  <button class="nav-btn" onclick="showTab('settings', this)">‚öôÔ∏è Setup</button>
</div>

<div class="container">
  
  <div id="daily" class="tab-content">
    <div class="card">
      <h2>Dagens Indtastning</h2>
      <label>Dato</label>
      <input type="date" id="date">
      <label>V√¶lg ruter (Hold Ctrl nede for flere)</label>
      <select id="routeSelect" multiple size="10"></select>
      <label>Arbejdstid (f.eks. 08:30 - 15:00)</label>
      <input type="text" id="workTime" placeholder="Tidsrum...">
      <button class="btn-save" onclick="saveDay()">‚úÖ Gem Arbejdsdag</button>
    </div>
  </div>

  <div id="dash" class="tab-content" style="display:none">
    <div class="card">
      <h2>Status Oversigt</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="stat-km">0.0</div>
          <div>KM (SKAT)</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-addr">0</div>
          <div>ADRESSER</div>
        </div>
      </div>
      <button class="btn-pdf" onclick="exportPDF()">üìÑ Eksporter PDF Rapport</button>
    </div>
  </div>

  <div id="history" class="tab-content" style="display:none">
    <div class="card">
      <h2>Historik</h2>
      <div id="historyList"></div>
      <button class="btn-pdf" style="background:#fff5f5; color:#c53030; border:1px solid #fed7d7; margin-top:20px;" onclick="clearHistory()">Slet Historik</button>
    </div>
  </div>

  <div id="settings" class="tab-content" style="display:none">
    <div class="card">
      <h2>Ops√¶tning</h2>
      <label>Google Sheets CSV URL</label>
      <input type="text" id="sheetUrl" placeholder="Inds√¶t CSV link her...">
      <button class="btn-sync" onclick="importFromSheets()">üîÑ Hent Rutedata</button>
    </div>
  </div>

</div>

<script>
  let routes = [];
  let log = [];

  function init() {
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    const r = localStorage.getItem('rt_routes'), l = localStorage.getItem('rt_log'), u = localStorage.getItem('rt_url');
    if (r) { routes = JSON.parse(r); renderRoutes(); }
    if (l) { log = JSON.parse(l); updateStats(); }
    if (u) document.getElementById('sheetUrl').value = u;
  }

  async function importFromSheets() {
    let url = document.getElementById('sheetUrl').value.trim();
    if (url.includes('/edit')) url = url.replace(/\/edit.*$/, '/export?format=csv');
    
    try {
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.split(/\r?\n/).filter(row => row.trim() !== "");
      const separator = rows[0].includes(';') ? ';' : ',';
      
      const headers = rows[0].split(separator).map(h => h.trim().toLowerCase());
      
      // Find kolonner dynamisk ud fra navne (A, B, D, J, K)
      const idxA = 0; // Postnr
      const idxB = 1; // Rutenr
      const idxAddr = 3; // Adresser (D)
      const idxUd = 9; // Ud (J)
      const idxHjem = 10; // Hjem (K)

      routes = rows.slice(1).map(row => {
        const c = row.split(separator);
        const p = c[idxA]?.trim() || "";
        const r = c[idxB]?.trim() || "";
        return { 
          id: p && r ? `${p}-${r}` : r || p, 
          addr: parseInt(c[idxAddr]) || 0,
          kmUd: parseFloat(c[idxUd]?.replace(',','.')) || 0, 
          kmHjem: parseFloat(c[idxHjem]?.replace(',','.')) || 0
        };
      }).filter(r => r.id.length > 2);

      localStorage.setItem('rt_routes', JSON.stringify(routes));
      localStorage.setItem('rt_url', url);
      renderRoutes();
      alert(`Succes! Hentet ${routes.length} ruter.`);
    } catch(e) { alert('Fejl ved hentning af data.'); }
  }

  function renderRoutes() {
    const s = document.getElementById('routeSelect');
    s.innerHTML = routes.map(r => `<option value="${r.id}">${r.id} (${r.addr} adr.)</option>`).join('');
  }

  function saveDay() {
    const selected = Array.from(document.getElementById('routeSelect').selectedOptions).map(o => o.value);
    if (!selected.length) return alert('V√¶lg ruter!');
    
    const dayRoutes = selected.map(id => routes.find(r => r.id === id));
    const totalAddr = dayRoutes.reduce((sum, r) => sum + r.addr, 0);
    const skatKm = (dayRoutes[0].kmUd + dayRoutes[dayRoutes.length-1].kmHjem).toFixed(1);
    
    log.push({
      date: document.getElementById('date').value,
      ruter: selected.join(', '),
      addr: totalAddr,
      km: skatKm,
      tid: document.getElementById('workTime').value
    });

    localStorage.setItem('rt_log', JSON.stringify(log));
    updateStats();
    alert('Arbejdsdag gemt!');
  }

  function updateStats() {
    const totalKm = log.reduce((sum, e) => sum + parseFloat(e.km), 0);
    const totalA = log.reduce((sum, e) => sum + e.addr, 0);
    document.getElementById('stat-km').innerText = totalKm.toFixed(1);
    document.getElementById('stat-addr').innerText = totalA;
  }

  function renderHistory() {
    const h = document.getElementById('historyList');
    h.innerHTML = log.map((e) => `
      <div class="history-item">
        <b>${e.date}</b> | ${e.tid || '--'} <br>
        Ruter: ${e.ruter} <br>
        Skat: ${e.km} km | Adresser: ${e.addr}
      </div>
    `).reverse().join('');
  }

  function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    btn.classList.add('active');
    if (id === 'history') renderHistory();
  }

  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text("K√∏rselsrapport", 14, 20);
    doc.setFontSize(10);
    doc.text("Genereret: " + new Date().toLocaleDateString(), 14, 28);
    
    const tableData = log.map(e => [e.date, e.ruter, e.addr, e.km + ' km', e.tid]);
    doc.autoTable({
      head: [['Dato', 'Ruter', 'Adresser', 'Skat KM', 'Tid']],
      body: tableData,
      startY: 35,
      theme: 'striped'
    });
    doc.save(`Rute_Rapport_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  function clearHistory() {
    if(confirm("Er du sikker p√•, at du vil slette hele din historik?")) {
      log = [];
      localStorage.removeItem('rt_log');
      updateStats();
      renderHistory();
    }
  }

  init();
</script>
</body>
</html>
