<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rute Tracker - Master</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto 20px; }
        h1, h2 { color: #2563eb; text-align: center; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
        .btn-main { background: #2563eb; color: white; }
        .btn-pdf { background: #16a34a; color: white; }
        .btn-setup { background: #64748b; color: white; }
        .history-item { background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid #2563eb; margin-bottom: 10px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section { display: none; }
        .active { display: block; }
        .nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .nav b { cursor: pointer; padding: 10px; color: #64748b; }
        .nav b.active-tab { color: #2563eb; border-bottom: 2px solid #2563eb; }
    </style>
</head>
<body>

    <h1>üöö Rute Tracker Master</h1>

    <div class="nav">
        <b id="t1" class="active-tab" onclick="show('daily', 't1')">DAGLIG</b>
        <b id="t2" onclick="show('history', 't2')">HISTORIK</b>
        <b id="t3" onclick="show('setup', 't3')">SETUP</b>
    </div>

    <div id="daily" class="section active">
        <div class="card">
            <label>Dato</label>
            <input type="date" id="date">
            <label>V√¶lg ruter (Hold Ctrl nede for flere)</label>
            <select id="routeSelect" multiple size="10"></select>
            <label>Arbejdstid (f.eks. 08:00 - 15:00)</label>
            <input type="text" id="worktime" placeholder="Indtast tid...">
            <button class="btn-main" onclick="saveDay()">GEM ARBEJDSDAG</button>
        </div>
    </div>

    <div id="history" class="section">
        <div class="card">
            <h2>Dashboard</h2>
            <div id="stats" style="text-align:center; font-weight:bold; margin-bottom:20px;">
                KM: <span id="totalKm">0</span> | Adresser: <span id="totalAddr">0</span>
            </div>
            <button class="btn-pdf" onclick="exportPDF()">EKSPORTER PDF</button>
        </div>
        <div id="historyList"></div>
        <button onclick="clearAll()" style="color:red; background:none;">Slet alt historik</button>
    </div>

    <div id="setup" class="section">
        <div class="card">
            <h2>Ops√¶tning</h2>
            <label>Google Sheets CSV URL</label>
            <input type="text" id="sheetUrl" placeholder="Inds√¶t CSV-link her...">
            <button class="btn-setup" onclick="sync()">HENT DATA FRA ARK</button>
            <p style="font-size:12px; color:#666; margin-top:15px;">
                Ark-struktur: A:Postnr, B:Rutenr, D:Adresser, E:Start-adr, F:Slut-adr, J:KM Ud, K:KM Hjem.
            </p>
        </div>
    </div>

<script>
    let routes = JSON.parse(localStorage.getItem('master_routes') || '[]');
    let log = JSON.parse(localStorage.getItem('master_log') || '[]');

    function init() {
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        const url = localStorage.getItem('master_url');
        if (url) document.getElementById('sheetUrl').value = url;
        renderRoutes();
        renderHistory();
    }

    async function sync() {
        let url = document.getElementById('sheetUrl').value.trim();
        if (url.includes('/edit')) url = url.replace(/\/edit.*$/, '/export?format=csv');
        
        try {
            const res = await fetch(url);
            const text = await res.text();
            const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
            const sep = rows[0].includes(';') ? ';' : ',';

            routes = rows.slice(1).map(row => {
                const c = row.split(sep);
                return {
                    id: `${c[0]?.trim()}-${c[1]?.trim()}`,
                    addr: parseInt(c[3]) || 0,
                    kmUd: parseFloat(c[9]?.replace(',','.')) || 0,
                    kmHjem: parseFloat(c[10]?.replace(',','.')) || 0,
                    start: c[4]?.trim() || '',
                    slut: c[5]?.trim() || ''
                };
            }).filter(r => r.id.length > 2);

            localStorage.setItem('master_routes', JSON.stringify(routes));
            localStorage.setItem('master_url', url);
            renderRoutes();
            alert('Synkroniseret! ' + routes.length + ' ruter fundet.');
            show('daily', 't1');
        } catch (e) { alert('Fejl: Tjek dit link og om det er "Udgivet p√• nettet" som CSV.'); }
    }

    function renderRoutes() {
        const s = document.getElementById('routeSelect');
        s.innerHTML = routes.map(r => `<option value="${r.id}">${r.id} (${r.addr} adr.)</option>`).join('');
    }

    function saveDay() {
        const selected = Array.from(document.getElementById('routeSelect').selectedOptions).map(o => o.value);
        if(!selected.length) return alert('V√¶lg ruter!');

        const dayR = selected.map(id => routes.find(r => r.id === id));
        const totalA = dayR.reduce((s, r) => s + r.addr, 0);
        const kmSkat = (dayR[0].kmUd + dayR[dayR.length-1].kmHjem).toFixed(1);
        
        let acubiz = [];
        for(let i=0; i < dayR.length-1; i++) {
            acubiz.push(`Fra ${dayR[i].id} Slut (${dayR[i].slut}) ‚Üí ${dayR[i+1].id} Start (${dayR[i+1].start})`);
        }

        log.push({
            date: document.getElementById('date').value,
            time: document.getElementById('worktime').value || '--',
            ruter: selected.join(', '),
            addr: totalA,
            km: kmSkat,
            acubiz: acubiz
        });

        localStorage.setItem('master_log', JSON.stringify(log));
        renderHistory();
        alert('Gemt!');
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        let tk = 0, ta = 0;
        list.innerHTML = log.map(e => {
            tk += parseFloat(e.km); ta += e.addr;
            return `<div class="history-item">
                <b>${e.date} (${e.time})</b><br>
                Ruter: ${e.ruter}<br>
                Skat: ${e.km} km | Adresser: ${e.addr}<br>
                ${e.acubiz.length ? `<small style="color:#2563eb">üìç Acubiz:<br>${e.acubiz.join('<br>')}</small>` : ''}
            </div>`;
        }).reverse().join('');
        document.getElementById('totalKm').innerText = tk.toFixed(1);
        document.getElementById('totalAddr').innerText = ta;
    }

    function show(id, tId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav b').forEach(b => b.classList.remove('active-tab'));
        document.getElementById(id).classList.add('active');
        document.getElementById(tId).classList.add('active-tab');
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("K√∏rselsrapport", 14, 15);
        const data = log.map(e => [e.date, e.ruter, e.addr, e.km, e.time]);
        doc.autoTable({ head: [['Dato', 'Ruter', 'Adr.', 'KM', 'Tid']], body: data, startY: 20 });
        doc.save('Rapport.pdf');
    }

    function clearAll() { if(confirm('Slet alt?')) { log = []; localStorage.removeItem('master_log'); renderHistory(); } }

    init();
</script>
</body>
</html>
