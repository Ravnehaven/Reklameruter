<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöö Rute Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; }
    header { background: #667eea; color: white; padding: 20px; text-align: center; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .tabs { display: flex; gap: 10px; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; background: none; border: none; font-weight: bold; color: #999; }
    .tab.active { color: #667eea; border-bottom: 3px solid #667eea; }
    .content { display: none; }
    .content.active { display: block; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 15px; font-size: 1.2rem; color: #444; }
    label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
    input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
    button { background: #667eea; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button:hover:not(:disabled) { background: #5568d3; }
    .secondary-btn { background: #f0f0f0; color: #333; margin-top: 5px; }
    .secondary-btn:hover { background: #e0e0e0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #667eea; color: white; }
    .notification { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 5px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .route-item { border-left: 4px solid #667eea; padding-left: 15px; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 0 4px 4px 0; }
  </style>
</head>
<body>

  <header>
    <h1>üöö Rute Tracker</h1>
    <p>Chauff√∏r dagbog & Skat beregner</p>
  </header>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="showTab('input', this)">üìù Indtastning</button>
      <button class="tab" onclick="showTab('history', this)">üìÖ Historik</button>
      <button class="tab" onclick="showTab('settings', this)">‚öôÔ∏è Ops√¶tning</button>
    </div>

    <div id="input" class="content active">
      <div class="card">
        <h2>Registrer K√∏rsler</h2>
        <label>Dato:</label>
        <input type="date" id="date">
        
        <label>Chauff√∏r:</label>
        <input type="text" id="driver" placeholder="Navn p√• chauff√∏r">
        
        <label>V√¶lg ruter (hold Ctrl/Cmd nede for flere):</label>
        <select id="routes" multiple size="8"></select>
        
        <div id="selectedContainer"></div>
        
        <button id="saveBtn" onclick="save()">‚úÖ Beregn Afstand & Gem</button>
      </div>
    </div>

    <div id="history" class="content">
      <div class="card">
        <h2>Samlet Oversigt (Skat)</h2>
        <div id="skatSummary"></div>
      </div>
      <div class="card">
        <h2>Detaljeret Historik</h2>
        <div id="historyContent"></div>
      </div>
    </div>

    <div id="settings" class="content">
      <div class="card">
        <h2>Forbind til Google Sheets</h2>
        <p style="font-size: 0.85rem; margin-bottom: 15px; color: #666;">
          1. G√• til dit ark -> Filer -> Del -> Udgiv p√• nettet.<br>
          2. V√¶lg "Hele dokumentet" og "Kommaseparerede v√¶rdier (.csv)".<br>
          3. Kopier linket og inds√¶t det herunder.
        </p>
        <label>Google Sheets CSV URL:</label>
        <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
        <button onclick="importSheet()">üì• Hent Rutedata Nu</button>
        <button class="secondary-btn" onclick="clearData()">üóëÔ∏è Slet alt historik</button>
      </div>
    </div>
  </div>

  <script>
    // Din faste hjemmeadresse
    const HOME = 'Rosenv√¶nget 2A, 4640 Faxe';
    
    let trips = [];
    let routes = [];
    let selectedIds = [];

    // Start programmet
    function init() {
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      loadFromStorage();
      renderRouteSelect();
      document.getElementById('routes').addEventListener('change', updateSelectedUI);
      
      // Hent URL hvis den er gemt
      const savedUrl = localStorage.getItem('sheetUrl');
      if (savedUrl) document.getElementById('sheetUrl').value = savedUrl;
    }

    // Hent ruter fra Google Sheets
    async function importSheet() {
      const url = document.getElementById('sheetUrl').value.trim();
      if (!url) { notify('‚ö†Ô∏è Inds√¶t venligst en URL'); return; }

      // Sikr at linket peger p√• CSV eksport
      let csvUrl = url;
      if (url.includes('/edit')) {
        csvUrl = url.replace(/\/edit.*$/, '/export?format=csv');
      }

      try {
        notify('‚è≥ Henter data fra arket...');
        const response = await fetch(csvUrl);
        const text = await response.text();
        
        // Parse CSV (ID, Startadresse, Slutadresse, Huse)
        const rows = text.split('\n').filter(line => line.trim() !== "");
        const newRoutes = rows.slice(1).map(row => {
          // H√•ndterer hvis folk bruger semikolon eller komma
          const cols = row.includes(';') ? row.split(';') : row.split(',');
          return {
            id: cols[0]?.trim(),
            start: cols[1]?.trim(),
            end: cols[2]?.trim(),
            houses: cols[3]?.trim() || '0'
          };
        }).filter(r => r.id && r.start);

        if (newRoutes.length === 0) throw new Error("Ingen data fundet");

        routes = newRoutes;
        localStorage.setItem('savedRoutes', JSON.stringify(routes));
        localStorage.setItem('sheetUrl', url);
        
        renderRouteSelect();
        notify(`‚úÖ ${routes.length} ruter blev opdateret!`);
      } catch (err) {
        notify('‚ùå Fejl: Tjek om arket er "Udgivet p√• nettet" som CSV');
        console.error(err);
      }
    }

    function renderRouteSelect() {
      const select = document.getElementById('routes');
      select.innerHTML = '';
      routes.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.text = `${r.id} (${r.start.split(',')[0]}...)`;
        select.appendChild(opt);
      });
    }

    function updateSelectedUI() {
      selectedIds = Array.from(document.getElementById('routes').selectedOptions).map(o => o.value);
      const container = document.getElementById('selectedContainer');
      container.innerHTML = selectedIds.length > 0 ? '<p><b>Valgt r√¶kkef√∏lge:</b></p>' : '';
      
      selectedIds.forEach((id, i) => {
        const r = routes.find(x => x.id === id);
        container.innerHTML += `
          <div class="route-item">
            <strong>${i+1}. ${r.id}</strong><br>
            <small>${r.start} ‚Üí ${r.end}</small>
            <textarea id="comm-${i}" placeholder="Bem√¶rkning til ruten..." style="height:40px; margin-top:5px;"></textarea>
          </div>`;
      });
    }

    const sleep = (ms) => new Promise(res => setTimeout(res, ms));

    async function save() {
      const date = document.getElementById('date').value;
      const driver = document.getElementById('driver').value || 'Ukendt';
      const btn = document.getElementById('saveBtn');

      if (selectedIds.length === 0) { notify('‚ö†Ô∏è V√¶lg mindst √©n rute'); return; }

      btn.disabled = true;
      btn.innerText = '‚åõ Beregner afstande...';

      try {
        const first = routes.find(r => r.id === selectedIds[0]);
        const last = routes.find(r => r.id === selectedIds[selectedIds.length - 1]);

        notify('üîç Beregner: Hjem ‚Üí Start');
        const kmFrom = await getDistance(HOME, first.start);
        
        await sleep(1200); // Overhold OSM regler (max 1 kald pr sek)
        
        notify('üîç Beregner: Slut ‚Üí Hjem');
        const kmTo = await getDistance(last.end, HOME);

        const tripData = {
          date,
          driver,
          kmFrom: parseFloat(kmFrom),
          kmTo: parseFloat(kmTo),
          selectedRoutes: selectedIds.map((id, i) => ({
            id,
            comment: document.getElementById(`comm-${i}`).value
          }))
        };

        trips.push(tripData);
        localStorage.setItem('trips', JSON.stringify(trips));
        
        notify(`‚úÖ Gemt! Total: ${(tripData.kmFrom + tripData.kmTo).toFixed(1)} km`);
        
        // Reset
        document.getElementById('routes').selectedIndex = -1;
        updateSelectedUI();
      } catch (e) {
        notify('‚ùå Fejl ved beregning. Pr√∏v igen.');
      } finally {
        btn.disabled = false;
        btn.innerText = '‚úÖ Beregn Afstand & Gem';
      }
    }

    async function getDistance(from, to) {
      const fCoord = await geocode(from);
      await sleep(1100);
      const tCoord = await geocode(to);
      
      if (!fCoord || !tCoord) return 5.0; // Fallback hvis adresse ikke findes

      try {
        const url = `https://router.project-osrm.org/route/v1/driving/${fCoord};${tCoord}?overview=false`;
        const res = await fetch(url);
        const d = await res.json();
        return d.routes ? (d.routes[0].distance / 1000).toFixed(1) : 5.0;
      } catch(e) { return 5.0; }
    }

    async function geocode(addr) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addr)}&format=json&limit=1&countrycodes=dk`;
        const res = await fetch(url, { headers: { 'X-Requested-With': 'RuteTracker' } });
        const data = await res.json();
        return data[0] ? `${data[0].lon},${data[0].lat}` : null;
      } catch(e) { return null; }
    }

    function showTab(id, btn) {
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      btn.classList.add('active');
      if (id === 'history') renderHistory();
    }

    function renderHistory() {
      const hist = document.getElementById('historyContent');
      const skat = document.getElementById('skatSummary');
      
      if (trips.length === 0) {
        hist.innerHTML = 'Ingen data gemt endnu.';
        skat.innerHTML = '0 km';
        return;
      }

      let totalKm = 0;
      
      // Sorter efter dato
      trips.sort((a,b) => new Date(b.date) - new Date(a.date));

      hist.innerHTML = trips.map(t => {
        const dagstotal = t.kmFrom + t.kmTo;
        totalKm += dagstotal;
        return `
          <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
            <strong>${new Date(t.date).toLocaleDateString('da-DK')}</strong> - ${t.driver}<br>
            <small>Ruter: ${t.selectedRoutes.map(r => r.id).join(', ')}</small><br>
            <span>Tur/Retur: ${t.kmFrom} + ${t.kmTo} = <b>${dagstotal.toFixed(1)} km</b></span>
          </div>`;
      }).join('');

      skat.innerHTML = `<h3>Total: ${totalKm.toFixed(1)} km</h3>`;
    }

    function notify(msg) {
      const n = document.createElement('div');
      n.className = 'notification';
      n.innerText = msg;
      document.body.appendChild(n);
      setTimeout(() => n.remove(), 4000);
    }

    function loadFromStorage() {
      const t = localStorage.getItem('trips');
      const r = localStorage.getItem('savedRoutes');
      if (t) trips = JSON.parse(t);
      if (r) routes = JSON.parse(r);
    }

    function clearData() {
      if (confirm('Er du sikker p√• du vil slette ALL historik?')) {
        localStorage.removeItem('trips');
        trips = [];
        renderHistory();
        notify('üóëÔ∏è Alt historik er slettet.');
      }
    }

    init();
  </script>
</body>
</html>
