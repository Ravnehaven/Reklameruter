<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöö Rute Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    header { background: #667eea; color: white; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .tabs { display: flex; gap: 10px; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; background: none; border: none; font-weight: bold; color: #999; }
    .tab.active { color: #667eea; border-bottom: 3px solid #667eea; }
    .content { display: none; }
    .content.active { display: block; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    input, select, textarea { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
    button { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button:hover:not(:disabled) { background: #5568d3; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #667eea; color: white; }
    .notification { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px; border-radius: 4px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <header>
    <h1>üöö Rute Tracker</h1>
    <p>Chauff√∏r dagbog med automatisk distanceberegning</p>
  </header>

  <div class="container">
    <div class="tabs">
      <button class="tab active" onclick="showTab('input', this)">üìù Daglig Indtastning</button>
      <button class="tab" onclick="showTab('history', this)">üìÖ Historik</button>
      <button class="tab" onclick="showTab('skat', this)">üí∞ Skat</button>
    </div>

    <div id="input" class="content active">
      <div class="card">
        <h2>Registrer Dagens K√∏rsler</h2>
        <label>Dato:</label>
        <input type="date" id="date">
        <label>Chauff√∏r:</label>
        <input type="text" id="driver" placeholder="Indtast navn">
        <label>V√¶lg ruter (hold Ctrl/Cmd nede for at v√¶lge flere):</label>
        <select id="routes" multiple size="6"></select>
        <div id="selected"></div>
        <button id="saveBtn" onclick="save()">‚úÖ Beregn & Gem K√∏rsler</button>
      </div>
    </div>

    <div id="history" class="content">
      <div class="card" id="historyContent"></div>
    </div>

    <div id="skat" class="content">
      <div class="card" id="skatContent"></div>
    </div>
  </div>

  <script>
    // Din faste hjemmeadresse
    const HOME = 'Rosenv√¶nget 2A, 4640 Faxe';
    
    let trips = [];
    let routes = [];
    let selectedIds = [];

    function init() {
      loadRoutes();
      loadTrips();
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      document.getElementById('routes').addEventListener('change', updateSelected);
    }

    function loadRoutes() {
      // Dine rutedata
      routes = [
        { id: '4640-01', start: 'Vestergade 1, Faxe', end: '√òstr√•gade 50, Faxe', houses: 240 },
        { id: '4640-02', start: 'N√∏rregade 1, Faxe', end: 'Sydgade 40, Faxe', houses: 210 },
        { id: '4640-03', start: 'Bogekrattet 5, Faxe', end: 'Voldstokken 25, Faxe', houses: 85 },
        { id: '4700-01', start: 'Torvet 1, N√¶stved', end: 'Ringvej 100, N√¶stved', houses: 320 },
        { id: '4700-02', start: 'Lindeg√•rdsvej 1, N√¶stved', end: 'Strandvejen 88, N√¶stved', houses: 150 }
      ];
      
      const select = document.getElementById('routes');
      routes.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.text = `${r.id} (${r.houses} huse)`;
        select.appendChild(opt);
      });
    }

    function updateSelected() {
      selectedIds = Array.from(document.getElementById('routes').selectedOptions).map(o => o.value);
      const container = document.getElementById('selected');
      
      if (selectedIds.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = '<p style="margin: 10px 0;"><strong>Valgt r√¶kkef√∏lge:</strong></p>';
      selectedIds.forEach((id, i) => {
        const r = routes.find(x => x.id === id);
        container.innerHTML += `
          <div class="card" style="border-left: 5px solid #667eea; background: #f9f9f9;">
            <b>Rute ${i+1}: ${r.id}</b><br>
            <small>${r.start} ‚Üí ${r.end}</small>
            <textarea id="c${i}" placeholder="Evt. kommentar til denne rute..." style="margin-top:5px;"></textarea>
          </div>`;
      });
    }

    // Funktion til at skabe kunstig pause (vigtigt for OpenStreetMap)
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    async function save() {
      const date = document.getElementById('date').value;
      const driver = document.getElementById('driver').value || 'Ukendt';
      const btn = document.getElementById('saveBtn');
      
      if (selectedIds.length === 0) {
        notify('‚ö†Ô∏è V√¶lg venligst mindst √©n rute.');
        return;
      }

      btn.disabled = true;
      btn.innerText = '‚åõ Arbejder...';

      try {
        const firstRoute = routes.find(r => r.id === selectedIds[0]);
        const lastRoute = routes.find(r => r.id === selectedIds[selectedIds.length - 1]);

        // 1. Beregn Hjem -> F√∏rste adresse
        notify('üîç Finder vej: Hjem ‚Üí F√∏rste rute...');
        const kmFrom = await getDistance(HOME, firstRoute.start);
        
        await sleep(1200); // Pause for at undg√• blokering

        // 2. Beregn Sidste adresse -> Hjem
        notify('üîç Finder vej: Sidste rute ‚Üí Hjem...');
        const kmTo = await getDistance(lastRoute.end, HOME);

        const tripRoutes = selectedIds.map((id, i) => ({
          ...routes.find(r => r.id === id),
          comment: document.getElementById(`c${i}`)?.value || ''
        }));

        trips.push({ 
          date, 
          driver, 
          routes: tripRoutes, 
          kmFrom: parseFloat(kmFrom), 
          kmTo: parseFloat(kmTo) 
        });

        localStorage.setItem('trips', JSON.stringify(trips));
        
        notify(`‚úÖ Gemt! Skat-distance: ${(parseFloat(kmFrom) + parseFloat(kmTo)).toFixed(1)} km`);
        
        // Nulstil
        selectedIds = [];
        document.getElementById('routes').selectedIndex = -1;
        updateSelected();
      } catch (error) {
        notify('‚ùå Der skete en fejl. Pr√∏v igen.');
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.innerText = '‚úÖ Gem K√∏rsler';
      }
    }

    async function getDistance(from, to) {
      const fromCoords = await geocode(from);
      await sleep(1100);
      const toCoords = await geocode(to);
