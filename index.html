<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rute Tracker Pro - 4640 Edition</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root { --primary: #667eea; --dark: #2d3748; --light: #f7fafc; }
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: var(--light); margin: 0; padding-bottom: 50px; }
    header { background: var(--primary); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }
    .nav { display: flex; justify-content: space-around; background: white; padding: 10px; sticky: top; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .nav-btn { border: none; background: none; font-weight: bold; color: #a0aec0; cursor: pointer; padding: 10px; }
    .nav-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h2 { font-size: 1.1rem; color: var(--dark); margin-top: 0; display: flex; justify-content: space-between; }
    label { display: block; margin: 15px 0 5px; font-size: 0.85rem; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-save { background: var(--primary); color: white; font-size: 1rem; }
    .btn-pdf { background: #48bb78; color: white; margin-top: 10px; }
    .btn-sync { background: #edf2f7; color: var(--dark); }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .stat-card { background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
    .history-item { border-bottom: 1px solid #edf2f7; padding: 15px 0; font-size: 0.9rem; }
  </style>
</head>
<body>

<header>
  <h1>üöö Rute Tracker Pro</h1>
</header>

<div class="nav">
  <button class="nav-btn active" onclick="showTab('daily', this)">üìù Daglig</button>
  <button class="nav-btn" onclick="showTab('dash', this)">üìä Dashboard</button>
  <button class="nav-btn" onclick="showTab('history', this)">üìÖ Historik</button>
  <button class="nav-btn" onclick="showTab('settings', this)">‚öôÔ∏è Setup</button>
</div>

<div class="container">
  
  <div id="daily" class="tab-content">
    <div class="card">
      <h2>Dagens Indtastning</h2>
      <label>Dato</label>
      <input type="date" id="date">
      
      <label>V√¶lg ruter (Hold Ctrl/Cmd nede for flere)</label>
      <select id="routeSelect" multiple size="6"></select>
      
      <label>Arbejdstid (f.eks. 08:00 - 14:00)</label>
      <input type="text" id="workTime" placeholder="Tidsrum...">
      
      <button class="btn-save" onclick="saveDay()">‚úÖ Gem Arbejdsdag</button>
    </div>
  </div>

  <div id="dash" class="tab-content" style="display:none">
    <div class="card">
      <h2>Status Oversigt</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="stat-km">0</div>
          <div style="font-size: 0.7rem;">KM I ALT (SKAT)</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stat-houses">0</div>
          <div style="font-size: 0.7rem;">HUSE I ALT</div>
        </div>
      </div>
      <button class="btn-pdf" onclick="exportPDF()">üìÑ Eksporter PDF Rapport</button>
    </div>
  </div>

  <div id="history" class="tab-content" style="display:none">
    <div class="card">
      <h2>K√∏rselslog & Acubiz</h2>
      <div id="historyList"></div>
    </div>
  </div>

  <div id="settings" class="tab-content" style="display:none">
    <div class="card">
      <h2>Teknisk Setup</h2>
      <label>Google Sheets CSV URL</label>
      <input type="text" id="sheetUrl" placeholder="Inds√¶t CSV link her...">
      <button class="btn-sync" onclick="importFromSheets()">üîÑ Synkroniser med Sheet</button>
      <p style="font-size: 0.7rem; color: #666; margin-top:10px;">Data gemmes automatisk i browseren og kan tilg√•s p√• denne enhed.</p>
    </div>
  </div>

</div>

<script>
  let routes = [];
  let log = [];

  function init() {
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    const r = localStorage.getItem('rt_routes'), l = localStorage.getItem('rt_log'), u = localStorage.getItem('rt_url');
    if (r) { routes = JSON.parse(r); renderRoutes(); }
    if (l) { log = JSON.parse(l); updateStats(); }
    if (u) document.getElementById('sheetUrl').value = u;
  }

  async function importFromSheets() {
    let url = document.getElementById('sheetUrl').value.trim();
    if (url.includes('/edit')) url = url.replace(/\/edit.*$/, '/export?format=csv');
    try {
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.split('\n').slice(1);
      routes = rows.map(row => {
        const c = row.includes(';') ? row.split(';') : row.split(',');
        return { 
          id: `${c[0]?.trim()}-${c[1]?.trim()}`, 
          houses: parseInt(c[3]) || 0,
          kmUd: parseFloat(c[9]?.replace(',','.')) || 0, 
          kmHjem: parseFloat(c[10]?.replace(',','.')) || 0,
          start: c[5]?.trim(), end: c[6]?.trim() // Bruges til Acubiz checklist
        };
      }).filter(r => r.id.length > 2);
      localStorage.setItem('rt_routes', JSON.stringify(routes));
      localStorage.setItem('rt_url', url);
      renderRoutes();
      alert('Data synkroniseret!');
    } catch(e) { alert('Kunne ikke hente data.'); }
  }

  function renderRoutes() {
    const s = document.getElementById('routeSelect');
    s.innerHTML = routes.map(r => `<option value="${r.id}">${r.id} (${r.houses} huse)</option>`).join('');
  }

  function saveDay() {
    const selected = Array.from(document.getElementById('routeSelect').selectedOptions).map(o => o.value);
    if (!selected.length) return alert('V√¶lg ruter!');
    
    const dayRoutes = selected.map(id => routes.find(r => r.id === id));
    const totalHouses = dayRoutes.reduce((sum, r) => sum + r.houses, 0);
    const skatKm = dayRoutes[0].kmUd + dayRoutes[dayRoutes.length-1].kmHjem;
    
    // Acubiz beregning (mellem ruter)
    let acubizInfo = "";
    if (dayRoutes.length > 1) {
      for(let i=0; i < dayRoutes.length-1; i++) {
        acubizInfo += `Fra ${dayRoutes[i].id} Slut ‚Üí ${dayRoutes[i+1].id} Start\n`;
      }
    }

    const entry = {
      date: document.getElementById('date').value,
      ruter: selected.join(', '),
      houses: totalHouses,
      km: skatKm.toFixed(1),
      tid: document.getElementById('workTime').value,
      acubiz: acubizInfo
    };

    log.push(entry);
    localStorage.setItem('rt_log', JSON.stringify(log));
    updateStats();
    alert('Dag gemt i historikken!');
  }

  function updateStats() {
    const totalKm = log.reduce((sum, e) => sum + parseFloat(e.km), 0);
    const totalH = log.reduce((sum, e) => sum + e.houses, 0);
    document.getElementById('stat-km').innerText = totalKm.toFixed(1);
    document.getElementById('stat-houses').innerText = totalH;
  }

  function renderHistory() {
    const h = document.getElementById('historyList');
    h.innerHTML = log.map((e, i) => `
      <div class="history-item">
        <b>${e.date} | ${e.tid || 'Ingen tid'}</b><br>
        Ruter: ${e.ruter}<br>
        Skat: ${e.km} km | Huse: ${e.houses}<br>
        <small style="color: #667eea">${e.acubiz ? 'üìç Acubiz: ' + e.acubiz : ''}</small>
      </div>
    `).reverse().join('');
  }

  function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    btn.classList.add('active');
    if (id === 'history') renderHistory();
  }

  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("K√∏rselsrapport - " + new Date().toLocaleDateString(), 14, 15);
    
    const tableData = log.map(e => [e.date, e.ruter, e.houses, e.km + ' km', e.tid]);
    doc.autoTable({
      head: [['Dato', 'Ruter', 'Huse', 'Skat KM', 'Tid']],
      body: tableData,
      startY: 25
    });
    doc.save(`RuteLog_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  init();
</script>
</body>
</html>
