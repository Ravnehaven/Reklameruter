<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rute Tracker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; background: #f5f5f5; color: #333; }
    header { background: #667eea; color: white; padding: 20px; text-align: center; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .tabs { display: flex; gap: 10px; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; background: none; border: none; font-weight: bold; color: #999; }
    .tab.active { color: #667eea; border-bottom: 3px solid #667eea; }
    .content { display: none; }
    .content.active { display: block; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
    button { background: #667eea; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
    button:disabled { background: #ccc; }
    .notification { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px; border-radius: 5px; z-index: 1000; }
  </style>
</head>
<body>

<header>
  <h1>ðŸšš Rute Tracker</h1>
</header>

<div class="container">
  <div class="tabs">
    <button class="tab active" onclick="showTab('input', this)">Indtastning</button>
    <button class="tab" onclick="showTab('history', this)">Historik</button>
    <button class="tab" onclick="showTab('settings', this)">OpsÃ¦tning</button>
  </div>

  <div id="input" class="content active">
    <div class="card">
      <input type="date" id="date">
      <input type="text" id="driver" placeholder="ChauffÃ¸r navn">
      <select id="routes" multiple size="8"></select>
      <div id="selectedContainer"></div>
      <button id="saveBtn" onclick="save()">Gem kÃ¸rsel</button>
    </div>
  </div>

  <div id="history" class="content">
    <div class="card" id="historyContent"></div>
  </div>

  <div id="settings" class="content">
    <div class="card">
      <label>Google Sheets CSV URL:</label>
      <input type="text" id="sheetUrl" placeholder="IndsÃ¦t link her...">
      <button onclick="importSheet()">Opdater ruter</button>
    </div>
  </div>
</div>

<script>
  const HOME = 'RosenvÃ¦nget 2A, 4640 Faxe';
  let trips = [], routes = [], selectedIds = [];

  function init() {
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    const t = localStorage.getItem('trips'), r = localStorage.getItem('savedRoutes');
    if (t) trips = JSON.parse(t);
    if (r) { routes = JSON.parse(r); renderSelect(); }
  }

  async function importSheet() {
    let url = document.getElementById('sheetUrl').value.trim();
    if (url.includes('/edit')) url = url.replace(/\/edit.*$/, '/export?format=csv');
    try {
      const res = await fetch(url);
      const text = await res.text();
      const rows = text.split('\n').filter(l => l.trim() !== "");
      routes = rows.slice(1).map(row => {
        const c = row.includes(';') ? row.split(';') : row.split(',');
        return { id: c[0]?.trim(), start: c[1]?.trim(), end: c[2]?.trim() };
      }).filter(r => r.id);
      localStorage.setItem('savedRoutes', JSON.stringify(routes));
      renderSelect();
      alert('Ruter opdateret!');
    } catch (e) { alert('Fejl ved hentning af ark'); }
  }

  function renderSelect() {
    const s = document.getElementById('routes');
    s.innerHTML = '';
    routes.forEach(r => {
      const o = document.createElement('option');
      o.value = r.id; o.text = r.id; s.appendChild(o);
    });
  }

  async function save() {
    const s = document.getElementById('routes');
    selectedIds = Array.from(s.selectedOptions).map(o => o.value);
    if (!selectedIds.length) return alert('VÃ¦lg rute');
    const b = document.getElementById('saveBtn');
    b.disabled = true; b.innerText = 'Beregner...';
    
    const first = routes.find(r => r.id === selectedIds[0]);
    const last = routes.find(r => r.id === selectedIds[selectedIds.length-1]);
    
    const k1 = await getDist(HOME, first.start);
    await new Promise(r => setTimeout(r, 1200));
    const k2 = await getDist(last.end, HOME);
    
    trips.push({ date: document.getElementById('date').value, km: parseFloat(k1)+parseFloat(k2) });
    localStorage.setItem('trips', JSON.stringify(trips));
    alert('Gemt!');
    b.disabled = false; b.innerText = 'Gem kÃ¸rsel';
  }

  async function getDist(f, t) {
    const fC = await geo(f); await new Promise(r => setTimeout(r, 1100));
    const tC = await geo(t);
    if(!fC || !tC) return 5;
    const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${fC};${tC}?overview=false`);
    const d = await res.json();
    return d.routes ? (d.routes[0].distance/1000).toFixed(1) : 5;
  }

  async function geo(a) {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(a)}&format=json&limit=1&countrycodes=dk`);
    const d = await res.json();
    return d[0] ? `${d[0].lon},${d[0].lat}` : null;
  }

  function showTab(id, b) {
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'history') {
      document.getElementById('historyContent').innerHTML = trips.map(t => `<p>${t.date}: ${t.km} km</p>`).join('');
    }
  }
  init();
  
</script>
</body>
</html>
