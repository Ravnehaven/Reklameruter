// Kopier denne kode til Google Apps Script
// 1. Gå til https://script.google.com
// 2. Klik Tools → Script editor
// 3. Paste denne kode
// 4. Klik Deploy → New deployment → Web app
// 5. Execute as: Me, Who has access: Anyone
// 6. Kopier URL'en med /exec og sæt den i route-tracker.html under PROXY_URL

const GOOGLE_MAPS_API_KEY = 'AIzaSyBC3gj0G0PSbLL98bCRvt-MiuUZPck0A6Y';
const SHEET_ID = '1XBDnloUNP6PNmAxyxcytCYoQYv2rGXGpxct6H5tjHa8';

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const action = e.parameter.action;
  
  try {
    let responseData = {};
    
    if (action === 'calculateDistance') {
      const origin = e.parameter.origin;
      const destination = e.parameter.destination;
      const distance = calculateDistance(origin, destination);
      responseData = { success: true, distance: distance };
    }
    else if (action === 'getRoutes') {
      const routes = getRoutesFromSheet();
      responseData = { success: true, routes: routes };
    }
    else if (action === 'uploadTrip') {
      const tripData = JSON.parse(e.postData.contents);
      const result = uploadTripToSheet(tripData);
      responseData = { success: true, message: 'Trip uploaded', result: result };
    }
    else {
      responseData = { success: false, error: 'Unknown action' };
    }
    
    return ContentService.createTextOutput(JSON.stringify(responseData))
      .setMimeType(ContentService.MimeType.JSON)
      .addHeader('Access-Control-Allow-Origin', '*')
      .addHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
      .addHeader('Access-Control-Allow-Headers', 'Content-Type');
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ 
      success: false, 
      error: error.toString() 
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .addHeader('Access-Control-Allow-Origin', '*')
    .addHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
    .addHeader('Access-Control-Allow-Headers', 'Content-Type');
  }
}

function getRoutesFromSheet() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheets()[0];
    const data = sheet.getDataRange().getValues();
    
    const routes = [];
    // Kolonner: 0=Rutenr, 1=Husstande, 2=Km, 3=Omdelertid, 4=Start, 5=Slut
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][4] && data[i][5]) { // Rutenr, Start, Slut må ikke være tomme
        routes.push({
          id: data[i][0],           // Rutenummer (f.eks. "4640-01")
          houses: parseInt(data[i][1]) || 0,  // Antal husstande
          km: parseFloat(data[i][2]) || 0,    // Rute km
          time: parseInt(data[i][3]) || 0,    // Omdelertid (minutter)
          start: data[i][4] || '',  // Start adresse
          end: data[i][5] || ''     // Slut adresse
        });
      }
    }
    
    Logger.log('Routes loaded: ' + routes.length);
    return routes;
  } catch (error) {
    Logger.log('Error loading routes: ' + error);
    return [];
  }
}

function calculateDistance(origin, destination) {
  try {
    const url = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(origin)}&destinations=${encodeURIComponent(destination)}&key=${GOOGLE_MAPS_API_KEY}&mode=driving&language=da`;
    
    const response = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
    const result = JSON.parse(response.getContentText());
    
    if (result.status === 'OK' && result.rows[0].elements[0].status === 'OK') {
      const distanceMeters = result.rows[0].elements[0].distance.value;
      const distanceKm = (distanceMeters / 1000).toFixed(1);
      Logger.log(`Distance calculated: ${origin} → ${destination} = ${distanceKm} km`);
      return parseFloat(distanceKm);
    } else {
      Logger.log('Google Maps error: ' + result.status);
      return 0;
    }
  } catch (error) {
    Logger.log('Error calculating distance: ' + error);
    return 0;
  }
}

function uploadTripToSheet(tripData) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName('Kørsler') || 
                  SpreadsheetApp.openById(SHEET_ID).insertSheet('Kørsler');
    
    // Tilføj header hvis tom
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['Dato', 'Chauffør', 'Rute 1', 'Rute 2', 'Rute 3', 'Rute 4', 'Rute 5', 'Rute 6', 
                       'I alt husstande', 'I alt km', 'I alt tid', 'Skat km fra', 'Skat km til', 'Kommentar']);
    }
    
    // Forbered rute-data
    const routeIds = tripData.routes.map(r => r.id).slice(0, 6);
    while (routeIds.length < 6) {
      routeIds.push('');
    }
    
    const totalHouses = tripData.routes.reduce((s, r) => s + (r.husstande || 0), 0);
    const totalKm = tripData.routes.reduce((s, r) => s + (r.rutelængde || 0), 0);
    const totalTime = tripData.routes.reduce((s, r) => s + (r.omdelertid || 0), 0);
    
    const comment = tripData.routes.map((r, i) => `Rute ${i + 1}: ${r.comment || ''}`).filter(c => c.includes(':')).join('; ');
    
    // Tilføj række
    sheet.appendRow([
      tripData.date,
      tripData.driverName,
      ...routeIds,
      totalHouses,
      totalKm.toFixed(1),
      totalTime,
      tripData.kmFromHome || 0,
      tripData.kmToHome || 0,
      comment
    ]);
    
    Logger.log('Trip uploaded successfully');
    return { rows: sheet.getLastRow() };
  } catch (error) {
    Logger.log('Error uploading to sheet: ' + error);
    throw error;
  }
}
