<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rute Tracker - 4640 Edition</title>
  <style>
    * { box-sizing: border-box; font-family: sans-serif; }
    body { background: #f0f4f8; padding: 15px; color: #333; line-height: 1.4; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); max-width: 500px; margin: 0 auto 15px; }
    h2 { margin-top: 0; color: #667eea; font-size: 1.3rem; display: flex; align-items: center; gap: 8px; }
    label { display: block; margin: 12px 0 5px; font-weight: bold; font-size: 0.9rem; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
    .btn-main { background: #667eea; color: white; margin-bottom: 10px; }
    .btn-main:active { transform: scale(0.98); }
    .btn-sub { background: #edf2f7; color: #4a5568; margin-top: 10px; }
    .history-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }
    .total-box { background: #667eea; color: white; padding: 15px; border-radius: 8px; text-align: center; margin-top: 10px; }
    .total-km { font-size: 1.5rem; font-weight: bold; }
  </style>
</head>
<body>

  <div class="card">
    <h2>üìù Registrer Tur</h2>
    <label>Dato:</label>
    <input type="date" id="date">
    
    <label>V√¶lg Rute (Postnr-Rute):</label>
    <select id="routeSelect"></select>
    
    <button class="btn-main" onclick="saveTrip()">‚úÖ Gem K√∏rsel</button>
  </div>

  <div class="card">
    <h2>‚öôÔ∏è Data Hentet fra Ark</h2>
    <input type="text" id="sheetUrl" placeholder="Inds√¶t Google Sheet CSV URL...">
    <button class="btn-sub" onclick="importData()">üîÑ Opdater Ruter</button>
  </div>

  <div class="card" id="historyCard">
    <h2>üìÖ Historik</h2>
    <div id="historyList"></div>
    <div class="total-box">
      <div style="font-size: 0.9rem; opacity: 0.9;">Samlet Skat km</div>
      <div id="totalDisplay" class="total-km">0.0 km</div>
    </div>
    <button class="btn-sub" style="background:#fff5f5; color:#c53030; border: 1px solid #fed7d7;" onclick="clearHistory()">Slet Historik</button>
  </div>

<script>
  let routes = [];
  let trips = [];

  function init() {
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    const savedRoutes = localStorage.getItem('routes_v3');
    const savedTrips = localStorage.getItem('trips_v3');
    const savedUrl = localStorage.getItem('sheetUrl_v3');
    
    if (savedRoutes) { routes = JSON.parse(savedRoutes); renderSelect(); }
    if (savedTrips) { trips = JSON.parse(savedTrips); renderHistory(); }
    if (savedUrl) { document.getElementById('sheetUrl').value = savedUrl; }
  }

  async function importData() {
    let url = document.getElementById('sheetUrl').value.trim();
    if (!url) return alert("Inds√¶t venligst en URL");
    if (url.includes('/edit')) url = url.replace(/\/edit.*$/, '/export?format=csv');

    try {
      const response = await fetch(url);
      const data = await response.text();
      const rows = data.split('\n').slice(1);
      
      routes = rows.map(row => {
        const c = row.includes(';') ? row.split(';') : row.split(',');
        // Kombinerer Kolonne A og Kolonne B med bindestreg
        const combinedId = `${c[0]?.trim()}-${c[1]?.trim()}`;
        return {
          id: combinedId,
          kmUd: c[9]?.trim(),   // Kolonne J
          kmHjem: c[10]?.trim() // Kolonne K
        };
      }).filter(r => r.kmUd && r.id.length > 1);

      localStorage.setItem('routes_v3', JSON.stringify(routes));
      localStorage.setItem('sheetUrl_v3', url);
      renderSelect();
      alert(`Succes! ${routes.length} ruter indl√¶st.`);
    } catch (e) {
      alert("Fejl ved hentning. Tjek dit link.");
    }
  }

  function renderSelect() {
    const s = document.getElementById('routeSelect');
    s.innerHTML = routes.map(r => `<option value="${r.id}">${r.id}</option>`).join('');
  }

  function saveTrip() {
    const id = document.getElementById('routeSelect').value;
    const date = document.getElementById('date').value;
    const r = routes.find(x => x.id === id);
    if (!r) return;

    // H√•ndterer b√•de komma og punktum i tallene
    const ud = parseFloat(r.kmUd.replace(',','.'));
    const hjem = parseFloat(r.kmHjem.replace(',','.'));
    const total = (ud + hjem).toFixed(1);

    trips.push({ date, id, total });
    localStorage.setItem('trips_v3', JSON.stringify(trips));
    renderHistory();
  }

  function renderHistory() {
    const list = document.getElementById('historyList');
    let total = 0;
    list.innerHTML = trips.map(t => {
      total += parseFloat(t.total);
      return `<div class="history-item"><div><b>${t.date}</b><br><small>${t.id}</small></div> <b>${t.total} km</b></div>`;
    }).reverse().join('');
    document.getElementById('totalDisplay').innerHTML = `${total.toFixed(1)} km`;
  }

  function clearHistory() {
    if (confirm("Vil du slette din historik?")) {
      trips = [];
      localStorage.removeItem('trips_v3');
      renderHistory();
    }
  }

  init();
</script>
</body>
</html>
